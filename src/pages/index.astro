---
import Container from '../components/container'
import Intro from '../components/intro.astro'
import Layout from '../components/layout'
import MoreStories from '../components/more-stories'
import { metaTagsFragment, responsiveImageFragment } from '../lib/fragments'

const graphqlRequest = {
  query: `
      {
        site: _site {
          favicon: faviconMetaTags {
            ...metaTagsFragment
          }
        }
        blog {
          seo: _seoMetaTags {
            ...metaTagsFragment
          }
        }
        allPosts(orderBy: date_DESC, first: 20) {
          title
          slug
          excerpt
          date
          coverImage {
            responsiveImage {
              ...responsiveImageFragment
            }
          }
          coverVideo {
            url
            alt
            video {
              thumbnailUrl
            }
          }
        }
      }

      ${metaTagsFragment}
      ${responsiveImageFragment}
    `
}

const response = await fetch('https://graphql.datocms.com/', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    Accept: 'application/json',
    Authorization: `Bearer ${import.meta.env.ASTRO_EXAMPLE_CMS_DATOCMS_API_TOKEN}`
  },
  body: JSON.stringify(graphqlRequest)
})
const parsedResponse = await response.json()

const posts = parsedResponse.data.allPosts

// const heroPost = posts.shift()
const morePosts = posts
---

<>
  <Layout currentSlug={''}>
    <Container>
      <Intro />
      <MoreStories posts={morePosts} />
    </Container>
  </Layout>
</>
